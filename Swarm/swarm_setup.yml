- name: Configure the Docker Swarm Cluster
  hosts: all
  become: yes
  vars:
    manager_node: "{{ groups['CPPlanta1'][0] }}"
    ansible_python_interpreter: /usr/bin/python3

  tasks:
    - name: Remove old Docker versions
      apt:
        name:
          - docker
          - docker-engine
          - docker.io
          - containerd
          - runc
        state: absent
        update_cache: yes
      become: yes

    - name: Install dependencies
      apt:
        name:
          - curl
          - ca-certificates
          - git
          - acl
          - python3
          - python3-pip
          - lsb-release
        state: present
        update_cache: yes
      become: yes

    - name: Add Docker's official GPG key and save it in the recommended keyring
      ansible.builtin.shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
      become: yes
      args:
        creates: /usr/share/keyrings/docker-archive-keyring.gpg
      ignore_errors: yes

    - name: Add Docker's repository
      ansible.builtin.shell: |
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu jammy stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
      become: yes
      ignore_errors: yes

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
      become: yes

    - name: Install Docker packages
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
        update_cache: yes
      become: yes

    - name: Install Docker SDK for Python
      apt:
        name: python3-docker
        state: present
      become: yes

    - name: Add users to the Docker group
      user:
        name: "{{ item }}"
        groups: docker
        append: yes
      loop:
        - "{{ ansible_ssh_user }}"
        - gitlab-runner

    - name: Ensure Docker service is running
      systemd:
        name: docker
        state: started
        enabled: true
      become: yes

    - name: Check if node is already part of a Swarm
      docker_swarm_info:
      register: swarm_info
      when: inventory_hostname == manager_node

    - name: Initialize Swarm on manager
      docker_swarm:
        state: present
        advertise_addr: "{{ ansible_host }}"
      when: inventory_hostname == manager_node

    - name: Get Swarm join tokens from manager
      docker_swarm_info:
      register: swarm_info
      delegate_to: "{{ manager_node }}"
      run_once: true

    - name: Join workers to Swarm
      docker_swarm:
        state: present
        join_token: "{{ swarm_info.swarm_facts.JoinTokens.Worker }}"
        remote_addrs:
          - "{{ groups['CPPlanta1'][0] }}"
      when:
        - inventory_hostname != manager_node
        - swarm_info.docker_swarm_active == false  

    - name: Copy stack.yml to manager
      copy:
        src: ./stack.yml
        dest: /home/{{ ansible_ssh_user }}/stack.yml
      delegate_to: "{{ manager_node }}"
      run_once: true

    - name: Deploy the stack on manager (with force update)
      shell: docker stack deploy --with-registry-auth --resolve-image always -c /home/{{ ansible_ssh_user }}/stack.yml CP-Planta
      args:
        chdir: /home/{{ ansible_ssh_user }}
      delegate_to: "{{ manager_node }}"
      run_once: true

    - name: Update non-runner services (force update)
      shell: |
        docker service update --force {{ item }}
      loop:
        - CP-Planta_backend
        - CP-Planta_frontend
        - CP-Planta_postgres_primary
        - CP-Planta_postgres_replica 
        - CP-Planta_pgadmin           
        - CP-Planta_pgbouncer 
      delegate_to: "{{ manager_node }}"
      run_once: true

    - name: Wait for services to stabilize
      pause:
        seconds: 30
      delegate_to: "{{ manager_node }}"
      run_once: true

    - name: Verify non-runner services are running
      shell: docker service ls --filter "name=CP-Planta_backend,CP-Planta_frontend,CP-Planta_postgres_primary,CP-Planta_postgres_replica,CP-Planta_pgadmin,CP-Planta_pgbouncer" --format "{{ '{{' }}.Name{{ '}}' }} {{ '{{' }}.Replicas{{ '}}' }} {{ '{{' }}.DesiredState{{ '}}' }}"
      register: service_list
      delegate_to: "{{ manager_node }}"
      run_once: true

    - name: Show non-runner services
      debug:
        var: service_list.stdout_lines
      run_once: true

    - name: Verify GitLab Runners are running
      shell: docker service ls --filter "name=CP-Planta_runners" --format "{{ '{{' }}.Name{{ '}}' }} {{ '{{' }}.Replicas{{ '}}' }} {{ '{{' }}.DesiredState{{ '}}' }}"
      register: runner_service_list
      delegate_to: "{{ manager_node }}"
      run_once: true

    - name: Show GitLab Runner services
      debug:
        var: runner_service_list.stdout_lines
      run_once: true

    - name: Ensure GitLab Runners are active
      shell: |
        docker service update --force CP-Planta_runners
      delegate_to: "{{ manager_node }}"
      run_once: true

    - name: Force update any failed non-runner services
      shell: |
        failed_services=$(docker service ls --filter "desired-state=running" --filter "replicas=0" -q --filter "name=CP-Planta_backend,CP-Planta_frontend,CP-Planta_postgres_primary,CP-Planta_postgres_replica,CP-Planta_pgadmin")
        if [ -n "$failed_services" ]; then
          for service in $failed_services; do
            docker service update --force $service || exit 1
          done
        fi
      delegate_to: "{{ manager_node }}"
      run_once: true
      register: result

    - name: Fail if force update failed
      fail:
        msg: "Some services failed to update"
      when: result.rc != 0
